<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Maturidade em IA - José Roberto Schmaltz</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --color-advanced: #4CAF50;
            --color-intermediate: #FF9800;
            --color-beginner: #F44336;
            --color-bg: #f8f9fa;
            --color-card: #ffffff;
            --color-text: #333333;
            --color-text-sec: #6c757d;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding-top: 0;
        }

        /* Classes Utilitárias */
        .d-none { display: none !important; }
        .cursor-pointer { cursor: pointer; }

        /* Header Fixo e Layout */
        .sticky-top-custom {
            position: sticky;
            top: 0;
            z-index: 1020;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .card-custom {
            background: var(--color-card);
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            height: 100%;
            padding: 20px;
        }
        
        .kpi-value { font-size: 1.8rem; font-weight: 700; }
        .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: var(--color-text-sec); }
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* Tabela Personalizada */
        .table-custom th {
            background-color: #f1f3f5;
            cursor: pointer;
            user-select: none;
        }
        .table-custom th:hover { background-color: #e9ecef; }
        .sort-icon { font-size: 0.8em; margin-left: 5px; color: #999; }

        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        /* Cores KPI */
        .text-success-custom { color: var(--color-advanced) !important; }
        .text-warning-custom { color: var(--color-intermediate) !important; }
        .text-danger-custom { color: var(--color-beginner) !important; }
        .bg-success-custom { background-color: var(--color-advanced) !important; }
        .bg-warning-custom { background-color: var(--color-intermediate) !important; }
        .bg-danger-custom { background-color: var(--color-beginner) !important; }

        @media (max-width: 991px) {
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3">Carregando Dados...</h5>
    </div>

    <div id="view-main">
        
        <header class="sticky-top-custom">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="m-0 fw-bold"><i class="fas fa-chart-line text-primary me-2"></i>Dashboard de Maturidade em IA</h4>
                    <small class="text-muted last-update-txt">Carregando...</small>
                </div>
                <div>
                    <button class="btn btn-outline-dark btn-sm me-2" onclick="switchView('tracks')">
                        <i class="fas fa-map-signs me-1"></i> Distribuição das Trilhas
                    </button>
                    <button class="btn btn-primary btn-sm btn-refresh"><i class="fas fa-sync-alt me-1"></i> Atualizar</button>
                </div>
            </div>

            <div class="card bg-light p-3">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">1. Área</label>
                        <select id="filter-area" class="form-select form-select-sm" onchange="applyFiltersMain()">
                            <option value="all">Todas as Áreas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">2. Vínculo</label>
                        <select id="filter-vinculo-d" class="form-select form-select-sm" onchange="applyFiltersMain()">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">3. Vinculação</label>
                        <select id="filter-vinculo-h" class="form-select form-select-sm" onchange="applyFiltersMain()">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">4. Busca (Nome/Email)</label>
                        <input type="text" id="filter-search" class="form-control form-control-sm" placeholder="Digite para buscar..." oninput="applyFiltersMain()">
                    </div>
                </div>
            </div>
        </header>

        <div class="container-fluid pb-5">
            <section class="row g-3 mb-4" id="kpi-section-main"></section>

            <h5 class="mb-3 border-bottom pb-2 text-primary">Análise Comportamental</h5>
            <section class="row g-3 mb-4">
                <div class="col-md-4"><div class="card-custom"><h6 class="fw-bold">Maturidade</h6><div class="chart-container"><canvas id="chart1"></canvas></div></div></div>
                <div class="col-md-4"><div class="card-custom"><h6 class="fw-bold">Top Ferramentas</h6><div class="chart-container"><canvas id="chart2"></canvas></div></div></div>
                <div class="col-md-4"><div class="card-custom"><h6 class="fw-bold">Frequência</h6><div class="chart-container"><canvas id="chart3"></canvas></div></div></div>
            </section>

            <h5 class="mb-3 border-bottom pb-2 text-primary">Diagnóstico de Competências</h5>
            <section class="row g-3 mb-4">
                <div class="col-lg-6"><div class="card-custom"><h6 class="fw-bold">Radar (P1-P12)</h6><div class="chart-container"><canvas id="chart5"></canvas></div></div></div>
                <div class="col-lg-6"><div class="card-custom"><h6 class="fw-bold">Histograma</h6><div class="chart-container"><canvas id="chart6"></canvas></div></div></div>
            </section>

            <h5 class="mb-3 border-bottom pb-2 text-primary">Estratégia e Desenvolvimento</h5>
            <section class="row g-3 mb-4">
                <div class="col-lg-6"><div class="card-custom"><h6 class="fw-bold">Áreas x Conhecimento</h6><div class="chart-container"><canvas id="chart4"></canvas></div></div></div>
                <div class="col-lg-6"><div class="card-custom"><h6 class="fw-bold">Trilhas Sugeridas</h6><div class="chart-container"><canvas id="chart8"></canvas></div></div></div>
            </section>
             <h5 class="mb-3 border-bottom pb-2 text-primary">Recomendações IA</h5>
             <div id="recommendations-container"></div>
        </div>
    </div>

    <div id="view-tracks" class="d-none">
        
        <header class="sticky-top-custom border-bottom border-warning">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="m-0 fw-bold"><i class="fas fa-map-signs text-warning me-2"></i>Distribuição das Trilhas</h4>
                    <small class="text-muted last-update-txt">Carregando...</small>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="switchView('main')">
                        <i class="fas fa-arrow-left me-1"></i> Voltar ao Dashboard
                    </button>
                    <button class="btn btn-primary btn-sm btn-refresh"><i class="fas fa-sync-alt me-1"></i> Atualizar</button>
                </div>
            </div>

            <div class="card bg-light p-3">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">1. Área</label>
                        <select id="filter-tracks-area" class="form-select form-select-sm" onchange="applyFiltersTracks()">
                            <option value="all">Todas as Áreas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">2. Vínculo</label>
                        <select id="filter-tracks-vinculo-d" class="form-select form-select-sm" onchange="applyFiltersTracks()">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">3. Vinculação</label>
                        <select id="filter-tracks-vinculo-h" class="form-select form-select-sm" onchange="applyFiltersTracks()">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">4. Nível de Maturidade</label>
                        <select id="filter-tracks-maturidade" class="form-select form-select-sm" onchange="applyFiltersTracks()">
                            <option value="all">Todos os Níveis</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <div class="container-fluid pb-5">
            <section class="row g-3 mb-4" id="kpi-section-tracks"></section>

            <h5 class="mb-3 border-bottom pb-2 text-primary">Diagnóstico da Seleção</h5>
            <section class="row g-3 mb-4">
                <div class="col-lg-6">
                    <div class="card-custom">
                        <h6 class="fw-bold">Radar de Competências (Seleção Atual)</h6>
                        <div class="chart-container">
                            <canvas id="chartRadarTracks"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card-custom">
                        <h6 class="fw-bold">Histograma de Pontuação Total</h6>
                        <div class="chart-container">
                            <canvas id="chartHistTracks"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <h5 class="mb-3 border-bottom pb-2 text-primary">Detalhamento dos Colaboradores</h5>
            <div class="card-custom p-0 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover table-custom mb-0" id="data-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable('nome')">Nome <i class="fas fa-sort sort-icon"></i></th>
                                <th onclick="sortTable('email')">E-mail <i class="fas fa-sort sort-icon"></i></th>
                                <th onclick="sortTable('vinculoColH')">Vínculo<i class="fas fa-sort sort-icon"></i></th>
                                <th onclick="sortTable('totalScore')" class="text-center">Pontuação <i class="fas fa-sort sort-icon"></i></th>
                                <th onclick="sortTable('maturidade')" class="text-center">Nível Maturidade <i class="fas fa-sort sort-icon"></i></th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div class="p-2 text-end text-muted small bg-light">
                    <span id="table-count">0</span> registros encontrados
                </div>
            </div>
        </div>
    </div>

    <template id="kpi-template">
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card-custom text-center py-3">
                <div class="kpi-label">Respondentes</div>
                <div class="kpi-value kpi-total">0</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card-custom text-center py-3">
                <div class="kpi-label">Média Geral</div>
                <div class="kpi-value kpi-media">0.0</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card-custom text-center py-3">
                <div class="kpi-label">Adoção IA</div>
                <div class="kpi-value kpi-adocao">0%</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card-custom text-center py-3">
                <div class="kpi-label">Segurança</div>
                <div class="kpi-value kpi-lgpd">0%</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card-custom text-center py-3">
                <div class="kpi-label">Prontidão (IPO)</div>
                <div class="kpi-value kpi-ipo">0</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card-custom text-center py-3 border-danger">
                <div class="kpi-label text-danger">Risco Crítico</div>
                <div class="kpi-value text-danger kpi-risco">0%</div>
            </div>
        </div>
    </template>

    <script>
        // ============================================
        // 1. CONFIGURAÇÃO E DADOS GLOBAIS
        // ============================================
        const SHEET_ID = '19NMA5UhmjIEGOvPuSOe2wZCII7q1nP7g8RcThDEhUXg';
        const COLORS = {
            green: '#4CAF50', orange: '#FF9800', red: '#F44336', blue: '#2196F3', grey: '#9E9E9E',
            bg_blue: 'rgba(33, 150, 243, 0.4)'
        };

        let rawData = { aba1: [], aba2: [], aba3: [] };
        let processedData = [];
        let chartInstances = {};
        let tableSort = { key: 'totalScore', order: 'desc' };

        // ============================================
        // 2. FETCH & PROCESSAMENTO
        // ============================================
        function getSheetUrl(sheetName) {
            return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        }

        async function fetchAllData() {
            try {
                const [r1, r2, r3] = await Promise.all([
                    fetch(getSheetUrl('Respostas ao formulário 1')).then(r => r.text()),
                    fetch(getSheetUrl('Pontuação')).then(r => r.text()),
                    fetch(getSheetUrl('Classificação')).then(r => r.text())
                ]);

                rawData.aba1 = Papa.parse(r1, { header: false }).data;
                rawData.aba2 = Papa.parse(r2, { header: false }).data;
                rawData.aba3 = Papa.parse(r3, { header: false }).data;

                processData();
                populateAllFilters();
                
                if (!document.getElementById('view-main').classList.contains('d-none')) {
                    applyFiltersMain();
                } else {
                    applyFiltersTracks();
                }

                document.getElementById('loader').classList.add('d-none');
                document.querySelectorAll('.last-update-txt').forEach(el => el.innerText = 'Atualizado: ' + new Date().toLocaleTimeString());

            } catch (error) {
                console.error(error);
                alert('Erro ao carregar dados: ' + error.message);
            }
        }

        function processData() {
            processedData = [];
            
            for (let i = 1; i < rawData.aba1.length; i++) {
                const row1 = rawData.aba1[i];
                const row2 = rawData.aba2[i];
                const row3 = rawData.aba3[i];

                if (!row1 || row1.length < 2 || !row1[1]) continue;

                // Mapeamento
                const email = row1[1];
                const nome = row1[2];
                const vinculoColD = row1[3] ? row1[3].trim() : "Não Informado"; // Coluna D
                const area = row1[4];
                const faixaEtaria = row1[6];
                const vinculoColH = row1[7] ? row1[7].trim() : "Não Informado"; // Coluna H
                
                const contatoTexto = row1[9] || "";
                const contatoIA = (contatoTexto.toLowerCase().includes("já usei") || contatoTexto.toLowerCase().includes("uso")) ? "Sim" : "Não";
                const ferramentas = row1[12] ? row1[12].split(/[,;]/).map(s => s.trim()).filter(s => s) : [];
                const frequencia = row1[13];
                const cuidadosTexto = row1[23] || "";
                const cuidadosDados = (cuidadosTexto.toLowerCase().includes("sim") || cuidadosTexto.toLowerCase().includes("tenho cuidado")) ? "Sim" : "Não";

                const scores = {};
                let totalScore = 0;
                if (row2) {
                    for (let j = 0; j < 12; j++) scores[`P${j+1}`] = parseFloat(row2[j] || 0);
                    totalScore = parseFloat(row2[12] || 0);
                }

                const maturidade = row3 ? (row3[0] || "Não Definido") : "Não Definido";
                const trilha = row3 ? row3[1] : "Geral";

                processedData.push({
                    id: i, nome, email, vinculoColD, vinculoColH, area, faixaEtaria,
                    contatoIA, cuidadosDados, ferramentas, frequencia,
                    scores, totalScore, maturidade, trilha
                });
            }
        }

        // ============================================
        // 3. GERENCIAMENTO DE FILTROS E VIEWS
        // ============================================

        function populateAllFilters() {
            const areas = new Set();
            const vinculosD = new Set();
            const vinculosH = new Set();
            const niveis = new Set();

            processedData.forEach(r => {
                if(r.area) areas.add(r.area);
                if(r.vinculoColD) vinculosD.add(r.vinculoColD);
                if(r.vinculoColH) vinculosH.add(r.vinculoColH);
                if(r.maturidade) niveis.add(r.maturidade);
            });

            // 1. DASHBOARD PRINCIPAL
            fillSelect('filter-area', areas);
            fillSelect('filter-vinculo-d', vinculosD);
            fillSelect('filter-vinculo-h', vinculosH);

            // 2. PÁGINA DE TRILHAS
            fillSelect('filter-tracks-area', areas);
            fillSelect('filter-tracks-vinculo-d', vinculosD);
            fillSelect('filter-tracks-vinculo-h', vinculosH);
            fillSelect('filter-tracks-maturidade', niveis);
        }

        function fillSelect(id, set) {
            const sel = document.getElementById(id);
            const savedVal = sel.value;
            sel.innerHTML = sel.options[0].outerHTML;
            Array.from(set).sort().forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.innerText = val;
                sel.appendChild(opt);
            });
            if (Array.from(set).includes(savedVal)) sel.value = savedVal;
        }

        function switchView(viewName) {
            if (viewName === 'tracks') {
                document.getElementById('view-main').classList.add('d-none');
                document.getElementById('view-tracks').classList.remove('d-none');
                applyFiltersTracks();
            } else {
                document.getElementById('view-tracks').classList.add('d-none');
                document.getElementById('view-main').classList.remove('d-none');
                applyFiltersMain();
            }
            window.scrollTo(0,0);
        }

        // --- Lógica Filtros MAIN ---
        function applyFiltersMain() {
            const fArea = document.getElementById('filter-area').value;
            const fVinculoD = document.getElementById('filter-vinculo-d').value;
            const fVinculoH = document.getElementById('filter-vinculo-h').value;
            const fSearch = document.getElementById('filter-search').value.toLowerCase();

            const data = processedData.filter(r => {
                const matchSearch = !fSearch || r.email.toLowerCase().includes(fSearch) || (r.nome && r.nome.toLowerCase().includes(fSearch));
                
                return (fArea === 'all' || r.area === fArea) &&
                       (fVinculoD === 'all' || r.vinculoColD === fVinculoD) &&
                       (fVinculoH === 'all' || r.vinculoColH === fVinculoH) &&
                       matchSearch;
            });
            renderMainDashboard(data);
        }

        // --- Lógica Filtros TRILHAS ---
        function applyFiltersTracks() {
            const fArea = document.getElementById('filter-tracks-area').value;
            const fVinculoD = document.getElementById('filter-tracks-vinculo-d').value;
            const fVinculoH = document.getElementById('filter-tracks-vinculo-h').value;
            const fMat = document.getElementById('filter-tracks-maturidade').value;

            const data = processedData.filter(r => {
                return (fArea === 'all' || r.area === fArea) &&
                       (fVinculoD === 'all' || r.vinculoColD === fVinculoD) &&
                       (fVinculoH === 'all' || r.vinculoColH === fVinculoH) &&
                       (fMat === 'all' || r.maturidade === fMat);
            });
            renderTracksDashboard(data);
        }

        // ============================================
        // 4. RENDERIZAÇÃO
        // ============================================

        function renderKPIs(data, containerId) {
            const container = document.getElementById(containerId);
            const template = document.getElementById('kpi-template').content.cloneNode(true);
            
            const total = data.length;
            const avgScore = total ? (data.reduce((s, r) => s + r.totalScore, 0) / total).toFixed(1) : 0;
            const adocao = total ? Math.round((data.filter(r => r.contatoIA === "Sim").length / total) * 100) : 0;
            const lgpd = total ? Math.round((data.filter(r => r.cuidadosDados === "Sim").length / total) * 100) : 0;
            const risco = total ? Math.round((data.filter(r => r.contatoIA === "Sim" && r.cuidadosDados === "Não").length / total) * 100) : 0;
            const ipo = Math.round((avgScore * (adocao/100) * (lgpd/100)));

            template.querySelector('.kpi-total').innerText = total;
            template.querySelector('.kpi-media').innerText = avgScore;
            
            const elAdocao = template.querySelector('.kpi-adocao');
            elAdocao.innerText = adocao + '%';
            elAdocao.className += (adocao < 50 ? ' text-danger-custom' : ' text-success-custom');

            const elLgpd = template.querySelector('.kpi-lgpd');
            elLgpd.innerText = lgpd + '%';
            elLgpd.className += (lgpd < 70 ? ' text-danger-custom' : ' text-success-custom');

            const elIpo = template.querySelector('.kpi-ipo');
            elIpo.innerText = ipo;
            elIpo.className += (ipo > 60 ? ' text-success-custom' : ' text-warning-custom');

            const elRisco = template.querySelector('.kpi-risco');
            elRisco.innerText = risco + '%';
            elRisco.className = `kpi-value ${risco > 15 ? 'text-danger' : 'text-success'}`;

            container.innerHTML = '';
            container.appendChild(template);
        }

        function renderMainDashboard(data) {
            renderKPIs(data, 'kpi-section-main');
            if(data.length === 0) return;
            renderChartMaturity(data, 'chart1');
            renderChartTools(data, 'chart2');
            renderChartFreq(data, 'chart3');
            renderChartAreas(data, 'chart4');
            renderChartRadar(data, 'chart5');
            renderChartHist(data, 'chart6');
            renderChartTrilhas(data, 'chart8');
            generateRecommendations(data);
        }

        function renderTracksDashboard(data) {
            renderKPIs(data, 'kpi-section-tracks');
            renderTable(data);
            if(data.length === 0) return;
            renderChartRadar(data, 'chartRadarTracks');
            renderChartHist(data, 'chartHistTracks');
        }

        // ============================================
        // 5. CHARTS
        // ============================================
        function getCtx(id) {
            if (chartInstances[id]) chartInstances[id].destroy();
            return document.getElementById(id).getContext('2d');
        }

        function renderChartRadar(data, canvasId) {
            const dims = Array.from({length: 12}, (_, i) => `P${i+1}`);
            const averages = dims.map(d => (data.reduce((acc, r) => acc + (r.scores[d] || 0), 0) / data.length).toFixed(1));
            const globalAvg = dims.map(d => (processedData.reduce((acc, r) => acc + (r.scores[d] || 0), 0) / processedData.length).toFixed(1));

            chartInstances[canvasId] = new Chart(getCtx(canvasId), {
                type: 'radar',
                data: {
                    labels: dims,
                    datasets: [
                        { label: 'Filtro Atual', data: averages, borderColor: COLORS.blue, backgroundColor: COLORS.bg_blue, fill: true },
                        { label: 'Global', data: globalAvg, borderColor: COLORS.grey, borderDash: [5,5], fill: false }
                    ]
                },
                options: { scales: { r: { min: 0, max: 10 } }, maintainAspectRatio: false }
            });
        }

        function renderChartHist(data, canvasId) {
            const bins = [0,0,0,0,0];
            data.forEach(r => {
                if (r.totalScore <= 20) bins[0]++;
                else if (r.totalScore <= 40) bins[1]++;
                else if (r.totalScore <= 60) bins[2]++;
                else if (r.totalScore <= 80) bins[3]++;
                else bins[4]++;
            });

            chartInstances[canvasId] = new Chart(getCtx(canvasId), {
                type: 'bar',
                data: {
                    labels: ['0-20', '21-40', '41-60', '61-80', '81-100'],
                    datasets: [{ label: 'Pessoas', data: bins, backgroundColor: [COLORS.red, COLORS.red, COLORS.orange, COLORS.green, COLORS.green] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderChartMaturity(data, id) {
            const counts = { Iniciante: 0, Intermediário: 0, Avançado: 0 };
            data.forEach(r => {
                if(r.maturidade.includes('Iniciante')) counts.Iniciante++;
                else if(r.maturidade.includes('Intermediário')) counts.Intermediário++;
                else if(r.maturidade.includes('Avançado')) counts.Avançado++;
            });
            chartInstances[id] = new Chart(getCtx(id), {
                type: 'doughnut',
                data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: [COLORS.red, COLORS.orange, COLORS.green] }] },
                options: { maintainAspectRatio: false }
            });
        }

        function renderChartTools(data, id) {
            const tc = {};
            data.forEach(r => r.ferramentas.forEach(f => tc[f] = (tc[f]||0)+1));
            const sorted = Object.entries(tc).sort((a,b)=>b[1]-a[1]).slice(0,5);
            chartInstances[id] = new Chart(getCtx(id), {
                type: 'bar',
                data: { labels: sorted.map(i=>i[0]), datasets: [{ label: 'Uso', data: sorted.map(i=>i[1]), backgroundColor: COLORS.blue }] },
                options: { indexAxis: 'y', maintainAspectRatio: false }
            });
        }

        function renderChartFreq(data, id) {
            const fc = {};
            data.forEach(r => fc[r.frequencia||"N/A"] = (fc[r.frequencia||"N/A"]||0)+1);
            chartInstances[id] = new Chart(getCtx(id), {
                type: 'pie',
                data: { labels: Object.keys(fc), datasets: [{ data: Object.values(fc), backgroundColor: [COLORS.blue, '#64B5F6', '#90CAF9', '#BBDEFB', '#E3F2FD'] }] },
                options: { maintainAspectRatio: false }
            });
        }

        function renderChartAreas(data, id) {
            const areas = [...new Set(data.map(r => r.area))];
            const ds = {
                Iniciante: areas.map(a => data.filter(r => r.area === a && r.maturidade.includes('Iniciante')).length),
                Intermediário: areas.map(a => data.filter(r => r.area === a && r.maturidade.includes('Intermediário')).length),
                Avançado: areas.map(a => data.filter(r => r.area === a && r.maturidade.includes('Avançado')).length)
            };
            chartInstances[id] = new Chart(getCtx(id), {
                type: 'bar',
                data: {
                    labels: areas,
                    datasets: [
                        { label: 'Iniciante', data: ds.Iniciante, backgroundColor: COLORS.red },
                        { label: 'Intermediário', data: ds.Intermediário, backgroundColor: COLORS.orange },
                        { label: 'Avançado', data: ds.Avançado, backgroundColor: COLORS.green }
                    ]
                }, options: { scales: { x: { stacked: true }, y: { stacked: true } }, maintainAspectRatio: false }
            });
        }

        function renderChartTrilhas(data, id) {
            const tr = {};
            data.forEach(r => tr[r.trilha||"Geral"] = (tr[r.trilha||"Geral"]||0)+1);
            const sorted = Object.entries(tr).sort((a,b)=>b[1]-a[1]);
            chartInstances[id] = new Chart(getCtx(id), {
                type: 'bar',
                data: { labels: sorted.map(i=>i[0]), datasets: [{ label: 'Indicações', data: sorted.map(i=>i[1]), backgroundColor: COLORS.blue }] },
                options: { indexAxis: 'y', maintainAspectRatio: false }
            });
        }

        // ============================================
        // 6. TABELA E ORDENAÇÃO
        // ============================================

        function sortTable(key) {
            if (tableSort.key === key) {
                tableSort.order = tableSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                tableSort.key = key;
                tableSort.order = 'desc';
            }
            applyFiltersTracks();
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            document.getElementById('table-count').innerText = data.length;
            tbody.innerHTML = '';

            data.sort((a, b) => {
                let valA = a[tableSort.key];
                let valB = b[tableSort.key];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return tableSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return tableSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            data.forEach(r => {
                const tr = document.createElement('tr');
                let badgeClass = 'bg-secondary';
                if(r.maturidade.includes('Avançado')) badgeClass = 'bg-success';
                else if(r.maturidade.includes('Intermediário')) badgeClass = 'bg-warning text-dark';
                else if(r.maturidade.includes('Iniciante')) badgeClass = 'bg-danger';

                tr.innerHTML = `
                    <td>${r.nome || 'N/A'}</td>
                    <td><small>${r.email}</small></td>
                    <td>${r.vinculoColH}</td>
                    <td class="text-center fw-bold">${r.totalScore.toFixed(1)}</td>
                    <td class="text-center"><span class="badge ${badgeClass}">${r.maturidade}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function generateRecommendations(data) {
            const container = document.getElementById('recommendations-container');
            const risk = data.filter(r => r.contatoIA === "Sim" && r.cuidadosDados === "Não").length;
            
            let html = '';
            if(risk > 0) {
                html += `<div class="alert alert-danger border-danger"><i class="fas fa-exclamation-triangle"></i> <strong>Risco Crítico:</strong> ${risk} usuários utilizam IA sem cuidados com dados (LGPD).</div>`;
            } else {
                html = '<div class="alert alert-success border-success"><i class="fas fa-check-circle"></i> Nenhum risco crítico imediato detectado nos filtros atuais.</div>';
            }
            container.innerHTML = html;
        }

        document.querySelectorAll('.btn-refresh').forEach(btn => btn.addEventListener('click', () => {
            document.getElementById('loader').classList.remove('d-none');
            fetchAllData();
        }));

        document.addEventListener('DOMContentLoaded', fetchAllData);

    </script>
</body>
</html>